<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - EnutriTrack</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        background: #f3f4f6;
        min-height: 100vh;
      }

      .container {
        display: flex;
        min-height: 100vh;
      }

      /* Estilos adicionales para mejoras visuales */
      .health-check-details {
        margin-top: 1rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #10b981;
      }

      .health-check-details.error {
        border-left-color: #ef4444;
        background: #fef2f2;
      }

      .health-check-details pre {
        font-size: 0.75rem;
        color: #6b7280;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* Sidebar */
      .sidebar {
        width: 280px;
        background: white;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        z-index: 100;
      }

      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .logo-icon {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }

      .logo-icon svg {
        width: 24px;
        height: 24px;
        color: white;
      }

      .sidebar-header-text h2 {
        color: #1f2937;
        font-size: 1.25rem;
        font-weight: 700;
      }

      .sidebar-header-text p {
        color: #6b7280;
        font-size: 0.75rem;
      }

      .nav-menu {
        list-style: none;
        padding: 1rem;
      }

      .nav-item {
        margin-bottom: 0.25rem;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        color: #6b7280;
        text-decoration: none;
        border-radius: 12px;
        transition: all 0.2s;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.9375rem;
      }

      .nav-link:hover {
        background: #f3f4f6;
        color: #10b981;
      }

      .nav-link.active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }

      .nav-link svg {
        width: 20px;
        height: 20px;
        margin-right: 0.75rem;
      }

      /* Doctor Profile */
      .doctor-profile {
        padding: 1rem;
        margin: 1rem;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius: 16px;
        border: 1px solid #d1fae5;
      }

      .doctor-profile-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .doctor-avatar {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.125rem;
      }

      .doctor-info h3 {
        font-size: 0.9375rem;
        color: #1f2937;
        font-weight: 600;
      }

      .doctor-info p {
        font-size: 0.75rem;
        color: #10b981;
      }

      .doctor-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }

      .doctor-stat {
        text-align: center;
        padding: 0.5rem;
        background: white;
        border-radius: 8px;
      }

      .doctor-stat-value {
        font-size: 1.125rem;
        font-weight: 700;
        color: #10b981;
      }

      .doctor-stat-label {
        font-size: 0.6875rem;
        color: #6b7280;
        margin-top: 0.125rem;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 280px;
        padding: 2rem;
      }

      .content-header {
        background: white;
        padding: 1.5rem 2rem;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left {
        flex: 1;
      }

      .greeting {
        font-size: 1.875rem;
        color: #1f2937;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }

      .date-time {
        color: #6b7280;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .date-time span {
        display: flex;
        align-items: center;
        gap: 0.375rem;
      }

      .date-time svg {
        width: 16px;
        height: 16px;
      }

      .header-actions {
        display: flex;
        gap: 0.75rem;
      }

      .btn {
        padding: 0.625rem 1.25rem;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn svg {
        width: 18px;
        height: 18px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
      }

      .btn-secondary {
        background: white;
        color: #6b7280;
        border: 2px solid #e5e7eb;
      }

      .btn-secondary:hover {
        border-color: #10b981;
        color: #10b981;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      /* Stats Cards - Redise√±adas */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        border: 1px solid #f0f0f0;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(
          90deg,
          var(--card-color),
          var(--card-color-light)
        );
        border-radius: 20px 20px 0 0;
      }

      .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      }

      .stat-card-content {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
      }

      .stat-card-title {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .stat-card-icon {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--card-bg);
        color: var(--card-color);
        box-shadow: 0 4px 12px var(--card-shadow);
      }

      .stat-card-icon svg {
        width: 28px;
        height: 28px;
      }

      .stat-card-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: #1f2937;
        margin-bottom: 0.5rem;
        line-height: 1;
      }

      .stat-card-description {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 1rem;
        flex-grow: 1;
      }

      .stat-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
      }

      .stat-card-change {
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-weight: 600;
      }

      .stat-card-change.positive {
        color: #10b981;
      }

      .stat-card-change.negative {
        color: #ef4444;
      }

      .stat-card-change svg {
        width: 16px;
        height: 16px;
      }

      .stat-card-trend {
        font-size: 0.75rem;
        color: #9ca3af;
        font-weight: 500;
      }

      /* Health Check Section */
      .health-check-section {
        margin-bottom: 2rem;
      }

      .health-check-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 2rem;
        border: 1px solid #f0f0f0;
      }

      .health-check-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .health-check-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
      }

      .health-check-status {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .status-indicator.healthy {
        background: #10b981;
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      }

      .status-indicator.warning {
        background: #f59e0b;
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
      }

      .status-indicator.error {
        background: #ef4444;
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
      }

      .status-text {
        font-weight: 600;
        font-size: 0.875rem;
      }

      .status-text.healthy {
        color: #10b981;
      }

      .status-text.warning {
        color: #f59e0b;
      }

      .status-text.error {
        color: #ef4444;
      }

      .health-check-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .health-check-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .health-check-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
      }

      .health-check-value {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
      }

      .health-check-actions {
        display: flex;
        gap: 0.75rem;
      }

      /* Database Configuration */
      .config-section {
        margin-bottom: 2rem;
      }

      .config-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 2rem;
        border: 1px solid #f0f0f0;
      }

      .config-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .config-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
      }

      .config-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .form-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
      }

      .form-control {
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .form-control:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
      }

      .config-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      /* Charts Section */
      .charts-section {
        margin-bottom: 2rem;
      }

      .charts-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .charts-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
      }

      .chart-container {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .chart-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
      }

      .chart-actions {
        display: flex;
        gap: 0.5rem;
      }

      .chart-content {
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Table Container */
      .table-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        margin-bottom: 2rem;
      }

      .table-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .table-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
      }

      .table-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .search-box {
        position: relative;
        width: 280px;
      }

      .search-box input {
        width: 100%;
        padding: 0.625rem 2.5rem 0.625rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .search-box input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
      }

      .search-box svg {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: #9ca3af;
      }

      .filter-dropdown {
        padding: 0.625rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 0.875rem;
        cursor: pointer;
        background: white;
        color: #6b7280;
        font-weight: 500;
        transition: all 0.2s;
      }

      .filter-dropdown:hover {
        border-color: #10b981;
        color: #10b981;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: #f9fafb;
      }

      th {
        padding: 1rem 1.5rem;
        text-align: left;
        font-size: 0.8125rem;
        font-weight: 700;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }

      td {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e7eb;
        color: #4b5563;
        font-size: 0.875rem;
      }

      tbody tr {
        transition: background 0.2s;
      }

      tbody tr:hover {
        background: #f9fafb;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        gap: 0.375rem;
      }

      .badge svg {
        width: 12px;
        height: 12px;
      }

      .badge-success {
        background: #d1fae5;
        color: #065f46;
      }

      .badge-warning {
        background: #fef3c7;
        color: #92400e;
      }

      .badge-danger {
        background: #fee2e2;
        color: #991b1b;
      }

      .badge-info {
        background: #dbeafe;
        color: #1e40af;
      }

      /* Patient Card */
      .patient-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .patient-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.875rem;
      }

      .patient-info h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1f2937;
      }

      .patient-info p {
        font-size: 0.75rem;
        color: #6b7280;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 0.5rem;
      }

      .btn-sm {
        padding: 0.5rem 0.875rem;
        font-size: 0.8125rem;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
      }

      .modal-header h3 {
        font-size: 1.25rem;
        color: #1f2937;
        font-weight: 700;
      }

      .modal-close {
        background: #f3f4f6;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .modal-close:hover {
        background: #e5e7eb;
      }

      .modal-close svg {
        width: 20px;
        height: 20px;
        color: #6b7280;
      }

      .modal-body {
        padding: 1.5rem;
      }

      .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        position: sticky;
        bottom: 0;
        background: white;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 1.5rem;
      }

      .tab {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        color: #6b7280;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }

      .tab:hover {
        color: #10b981;
      }

      .tab.active {
        color: #10b981;
        border-bottom-color: #10b981;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Detail Grid */
      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .detail-item {
        padding: 1rem;
        background: #f9fafb;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .detail-label {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }

      .detail-value {
        font-size: 0.9375rem;
        color: #1f2937;
        font-weight: 600;
      }

      /* Form Elements */
      .form-group {
        margin-bottom: 1.25rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
      }

      .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .form-control:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      /* Loading & Empty States */
      .loading,
      .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
      }

      .loading svg,
      .empty-state svg {
        width: 64px;
        height: 64px;
        margin: 0 auto 1rem;
        opacity: 0.5;
        color: #9ca3af;
      }

      .view {
        display: none;
      }

      .view.active {
        display: block;
      }

      /* Progress Bar */
      .progress-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 9999px;
        overflow: hidden;
        margin-top: 0.5rem;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        transition: width 0.3s;
      }

      /* Info Cards */
      .info-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .info-card {
        padding: 1.25rem;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius: 12px;
        border: 1px solid #d1fae5;
      }

      .info-card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .info-card-icon {
        width: 36px;
        height: 36px;
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #10b981;
      }

      .info-card-icon svg {
        width: 20px;
        height: 20px;
      }

      .info-card-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #065f46;
      }

      .info-card-content {
        font-size: 0.8125rem;
        color: #166534;
        line-height: 1.5;
      }

      /* Chart Styles */
      .chart {
        width: 100%;
        height: 100%;
        position: relative;
      }

      .bar-chart {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 200px;
        padding: 0 1rem;
      }

      .bar-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 12%;
      }

      .bar {
        width: 100%;
        background: linear-gradient(to top, #10b981, #34d399);
        border-radius: 4px 4px 0 0;
        transition: height 0.5s ease;
        position: relative;
      }

      .bar-label {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #6b7280;
        text-align: center;
      }

      .bar-value {
        position: absolute;
        top: -20px;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #1f2937;
      }

      .line-chart {
        position: relative;
        height: 200px;
        padding: 1rem;
      }

      .line-chart-path {
        fill: none;
        stroke: #10b981;
        stroke-width: 3;
      }

      .line-chart-area {
        fill: rgba(16, 185, 129, 0.1);
      }

      .pie-chart {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto;
      }

      .pie-segment {
        position: absolute;
        width: 100%;
        height: 100%;
        clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 50% 100%);
        border-radius: 50%;
        transform-origin: center;
      }

      .pie-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        margin-top: 1rem;
      }

      .pie-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
      }

      .pie-legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s;
        }

        .sidebar.mobile-open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .charts-grid {
          grid-template-columns: 1fr;
        }

        .content-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <div class="sidebar-header-text">
            <h2>EnutriTrack</h2>
            <p>Panel de Administraci√≥n</p>
          </div>
        </div>

        <!-- Admin Profile -->
        <div class="doctor-profile">
          <div class="doctor-profile-header">
            <div class="doctor-avatar" id="admin-avatar">SA</div>
            <div class="doctor-info">
              <h3 id="admin-name">Superusuario</h3>
              <p id="admin-role">Administrador</p>
            </div>
          </div>
          <div class="doctor-stats">
            <div class="doctor-stat">
              <div class="doctor-stat-value" id="admin-doctors-count">0</div>
              <div class="doctor-stat-label">Doctores</div>
            </div>
            <div class="doctor-stat">
              <div class="doctor-stat-value" id="admin-patients-count">0</div>
              <div class="doctor-stat-label">Pacientes</div>
            </div>
          </div>
        </div>

        <ul class="nav-menu">
          <li class="nav-item">
            <a class="nav-link active" data-view="dashboard">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                />
              </svg>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-view="admins">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              Administradores
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-view="doctors">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
              Doctores
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-view="patients">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                />
              </svg>
              Pacientes
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-view="analytics">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                />
              </svg>
              An√°lisis y Reportes
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-view="search">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              B√∫squeda Avanzada
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/api/docs" target="_blank">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              Documentaci√≥n API
            </a>
          </li>
        </ul>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <div class="content-header">
          <div class="header-left">
            <h1 class="greeting" id="greeting">Buenas tardes, Superusuario</h1>
            <div class="date-time">
              <span>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>
                <span id="current-date">martes, 9 de septiembre de 2025</span>
              </span>
              <span>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <span id="current-time">16:50</span>
              </span>
            </div>
          </div>
          <div class="header-actions">
            <button class="btn btn-danger" onclick="logout()">
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view active">
          <!-- Health Check Section -->
          <div class="health-check-section">
            <div class="health-check-card">
              <div class="health-check-header">
                <h2 class="health-check-title">Estado del Sistema</h2>
                <div class="health-check-status">
                  <div
                    class="status-indicator healthy"
                    id="health-status-indicator"
                  ></div>
                  <span class="status-text healthy" id="health-status-text"
                    >Conectado</span
                  >
                </div>
              </div>
              <div class="health-check-grid">
                <div class="health-check-item">
                  <span class="health-check-label">Tiempo de Respuesta</span>
                  <span class="health-check-value" id="response-time"
                    >45ms</span
                  >
                </div>
                <div class="health-check-item">
                  <span class="health-check-label">√öltima Verificaci√≥n</span>
                  <span class="health-check-value" id="last-check"
                    >Hace 2 min</span
                  >
                </div>
                <div class="health-check-item">
                  <span class="health-check-label">Servidor Backend</span>
                  <span class="health-check-value" id="api-status"
                    >En l√≠nea</span
                  >
                </div>
              </div>

              <!-- Detalles adicionales del health check -->
              <div
                class="health-check-details"
                id="health-details"
                style="display: none"
              >
                <pre id="health-details-content"></pre>
              </div>

              <div class="health-check-actions">
                <button class="btn btn-secondary" onclick="runHealthCheck()">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                    />
                  </svg>
                  Verificar Estado
                </button>
                <button class="btn btn-primary" onclick="toggleHealthDetails()">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  Detalles T√©cnicos
                </button>
              </div>
            </div>
          </div>

          <!-- Database Configuration Section -->
          <div
            class="config-section"
            id="database-config-section"
            style="display: none"
          >
            <div class="config-card">
              <div class="config-header">
                <h2 class="config-title">Configuraci√≥n de Base de Datos</h2>
                <button
                  class="btn btn-secondary"
                  onclick="hideDatabaseConfig()"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                  Cerrar
                </button>
              </div>
              <div class="config-form">
                <div class="form-group">
                  <label class="form-label">Host de Base de Datos</label>
                  <input
                    type="text"
                    class="form-control"
                    id="db-host"
                    placeholder="localhost"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Puerto</label>
                  <input
                    type="number"
                    class="form-control"
                    id="db-port"
                    placeholder="5432"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Nombre de Base de Datos</label>
                  <input
                    type="text"
                    class="form-control"
                    id="db-name"
                    placeholder="enutritrack"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Usuario</label>
                  <input
                    type="text"
                    class="form-control"
                    id="db-user"
                    placeholder="usuario"
                  />
                </div>
              </div>
              <div class="config-actions">
                <button
                  class="btn btn-secondary"
                  onclick="resetDatabaseConfig()"
                >
                  Restablecer
                </button>
                <button class="btn btn-primary" onclick="saveDatabaseConfig()">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                  Guardar Configuraci√≥n
                </button>
              </div>
            </div>
          </div>

          <!-- Stats Cards - Redise√±adas -->
          <div class="stats-grid">
            <!-- Card 1: Total Administradores -->
            <div
              class="stat-card"
              style="
                --card-color: #3b82f6;
                --card-color-light: #60a5fa;
                --card-bg: #dbeafe;
                --card-shadow: rgba(59, 130, 246, 0.3);
              "
            >
              <div class="stat-card-content">
                <div class="stat-card-header">
                  <span class="stat-card-title">Total Administradores</span>
                  <div class="stat-card-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                      <path
                        d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
                      />
                    </svg>
                  </div>
                </div>
                <div class="stat-card-value" id="stat-total-admins">0</div>
                <div class="stat-card-description">
                  Administradores activos en el sistema con acceso completo
                </div>
                <div class="stat-card-footer">
                  <div class="stat-card-change positive">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                      <path
                        fill-rule="evenodd"
                        d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <span id="stat-admins-growth">+0%</span>
                  </div>
                  <span class="stat-card-trend">vs. mes anterior</span>
                </div>
              </div>
            </div>

            <!-- Card 2: Total Doctores -->
            <div
              class="stat-card"
              style="
                --card-color: #10b981;
                --card-color-light: #34d399;
                --card-bg: #d1fae5;
                --card-shadow: rgba(16, 185, 129, 0.3);
              "
            >
              <div class="stat-card-content">
                <div class="stat-card-header">
                  <span class="stat-card-title">Total Doctores</span>
                  <div class="stat-card-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                      <path
                        fill-rule="evenodd"
                        d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                </div>
                <div class="stat-card-value" id="stat-total-doctors">0</div>
                <div class="stat-card-description">
                  Profesionales m√©dicos registrados en la plataforma
                </div>
                <div class="stat-card-footer">
                  <div class="stat-card-change positive">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                      <path
                        fill-rule="evenodd"
                        d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <span id="stat-doctors-growth">+0%</span>
                  </div>
                  <span class="stat-card-trend">vs. mes anterior</span>
                </div>
              </div>
            </div>

            <!-- Card 3: Total Pacientes -->
            <div
              class="stat-card"
              style="
                --card-color: #f59e0b;
                --card-color-light: #fbbf24;
                --card-bg: #fef3c7;
                --card-shadow: rgba(245, 158, 11, 0.3);
              "
            >
              <div class="stat-card-content">
                <div class="stat-card-header">
                  <span class="stat-card-title">Total Pacientes</span>
                  <div class="stat-card-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                      <path
                        d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"
                      />
                    </svg>
                  </div>
                </div>
                <div class="stat-card-value" id="stat-total-patients">0</div>
                <div class="stat-card-description">
                  Pacientes registrados con seguimiento nutricional activo
                </div>
                <div class="stat-card-footer">
                  <div class="stat-card-change positive">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                      <path
                        fill-rule="evenodd"
                        d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <span id="stat-patients-growth">+0%</span>
                  </div>
                  <span class="stat-card-trend">vs. mes anterior</span>
                </div>
              </div>
            </div>

            <!-- Card 4: Pacientes Activos -->
            <div
              class="stat-card"
              style="
                --card-color: #8b5cf6;
                --card-color-light: #a78bfa;
                --card-bg: #ede9fe;
                --card-shadow: rgba(139, 92, 246, 0.3);
              "
            >
              <div class="stat-card-content">
                <div class="stat-card-header">
                  <span class="stat-card-title">Pacientes Activos</span>
                  <div class="stat-card-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                </div>
                <div class="stat-card-value" id="stat-active-patients">0</div>
                <div class="stat-card-description">
                  Pacientes con actividad reciente en la plataforma
                </div>
                <div class="stat-card-footer">
                  <div class="stat-card-change positive">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                      <path
                        fill-rule="evenodd"
                        d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <span id="stat-active-growth">+0%</span>
                  </div>
                  <span class="stat-card-trend">vs. mes anterior</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="charts-section">
            <div class="charts-header">
              <h2 class="charts-title">M√©tricas de Doctores y Usuarios</h2>
              <select class="filter-dropdown" id="charts-period">
                <option value="week">√öltima semana</option>
                <option value="month">√öltimo mes</option>
                <option value="quarter">√öltimo trimestre</option>
              </select>
            </div>

            <div class="charts-grid">
              <!-- Gr√°fica 1: Distribuci√≥n de pacientes por doctor -->
              <div class="chart-container">
                <div class="chart-header">
                  <h3 class="chart-title">
                    Distribuci√≥n de Pacientes por Doctor
                  </h3>
                  <div class="chart-actions">
                    <button
                      class="btn btn-secondary btn-sm"
                      onclick="downloadChart('patients-per-doctor')"
                    >
                      <svg
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                      </svg>
                      Exportar
                    </button>
                  </div>
                </div>
                <div class="chart-content">
                  <div class="chart bar-chart" id="patients-per-doctor-chart">
                    <div class="loading">Cargando gr√°fica...</div>
                  </div>
                </div>
              </div>

              <!-- Gr√°fica 2: Evoluci√≥n de usuarios registrados -->
              <div class="chart-container">
                <div class="chart-header">
                  <h3 class="chart-title">Evoluci√≥n de Usuarios Registrados</h3>
                  <div class="chart-actions">
                    <button
                      class="btn btn-secondary btn-sm"
                      onclick="downloadChart('users-evolution')"
                    >
                      <svg
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                      </svg>
                      Exportar
                    </button>
                  </div>
                </div>
                <div class="chart-content">
                  <div class="chart line-chart" id="users-evolution-chart">
                    <div class="loading">Cargando gr√°fica...</div>
                  </div>
                </div>
              </div>

              <!-- Gr√°fica 3: Especialidades de doctores -->
              <div class="chart-container">
                <div class="chart-header">
                  <h3 class="chart-title">Distribuci√≥n por Especialidad</h3>
                  <div class="chart-actions">
                    <button
                      class="btn btn-secondary btn-sm"
                      onclick="downloadChart('doctors-specialties')"
                    >
                      <svg
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                      </svg>
                      Exportar
                    </button>
                  </div>
                </div>
                <div class="chart-content">
                  <div class="chart pie-chart" id="doctors-specialties-chart">
                    <div class="loading">Cargando gr√°fica...</div>
                  </div>
                </div>
              </div>

              <!-- Gr√°fica 4: Actividad de doctores -->
              <div class="chart-container">
                <div class="chart-header">
                  <h3 class="chart-title">Actividad de Doctores (Consultas)</h3>
                  <div class="chart-actions">
                    <button
                      class="btn btn-secondary btn-sm"
                      onclick="downloadChart('doctors-activity')"
                    >
                      <svg
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                      </svg>
                      Exportar
                    </button>
                  </div>
                </div>
                <div class="chart-content">
                  <div class="chart bar-chart" id="doctors-activity-chart">
                    <div class="loading">Cargando gr√°fica...</div>
                  </div>
                </div>
              </div>

              <!-- Gr√°fica 5: Distribuci√≥n por g√©nero de pacientes -->
              <div class="chart-container">
                <div class="chart-header">
                  <h3 class="chart-title">Distribuci√≥n por G√©nero</h3>
                  <div class="chart-actions">
                    <button
                      class="btn btn-secondary btn-sm"
                      onclick="downloadChart('gender-distribution')"
                    >
                      <svg
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                      </svg>
                      Exportar
                    </button>
                  </div>
                </div>
                <div class="chart-content">
                  <div class="chart pie-chart" id="gender-distribution-chart">
                    <div class="loading">Cargando gr√°fica...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Registros Recientes</h3>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Fecha de Registro</th>
                </tr>
              </thead>
              <tbody id="recent-registrations">
                <tr>
                  <td colspan="4" class="loading">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                      />
                    </svg>
                    <p>Cargando registros...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Admins View -->
        <div id="admins-view" class="view">
          <div class="chart-container">
            <h3 style="margin-bottom: 1.5rem; font-weight: 700; color: #1f2937">
              Mi Perfil de Administrador
            </h3>
            <div id="current-admin-info" class="detail-grid">
              <div class="loading">Cargando informaci√≥n...</div>
            </div>
          </div>

          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Otros Administradores</h3>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Doctores Creados</th>
                  <th>Estado</th>
                  <th>Fecha de Registro</th>
                </tr>
              </thead>
              <tbody id="admins-table">
                <tr>
                  <td colspan="5" class="loading">
                    Cargando administradores...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="doctors-view" class="view">
          <iframe
            src="doctors-crud.html"
            id="doctors-crud-frame"
            style="
              width: 100%;
              height: calc(100vh - 120px);
              border: none;
              background: white;
              border-radius: 0 0 16px 16px;
            "
            title="Gesti√≥n de Doctores"
          ></iframe>
        </div>

        <!-- Patients View -->
        <div id="patients-view" class="view">
          <iframe
            src="patients-crud.html"
            id="patients-crud-frame"
            style="
              width: 100%;
              height: calc(100vh - 120px);
              border: none;
              background: white;
              border-radius: 0 0 16px 16px;
            "
            title="Gesti√≥n de Pacientes"
          ></iframe>
        </div>

        <!-- Analytics View -->
        <div id="analytics-view" class="view">
          <div class="info-cards">
            <div class="info-card">
              <div class="info-card-header">
                <div class="info-card-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                    />
                  </svg>
                </div>
                <span class="info-card-title">An√°lisis de Progreso</span>
              </div>
              <p class="info-card-content">
                Monitorea el progreso de peso y medidas de tus pacientes a lo
                largo del tiempo.
              </p>
            </div>

            <div class="info-card">
              <div class="info-card-header">
                <div class="info-card-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                    />
                  </svg>
                </div>
                <span class="info-card-title">Reporte de Consumo</span>
              </div>
              <p class="info-card-content">
                An√°lisis detallado del consumo nutricional mensual de cada
                paciente.
              </p>
            </div>

            <div class="info-card">
              <div class="info-card-header">
                <div class="info-card-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                </div>
                <span class="info-card-title">Historial M√©dico</span>
              </div>
              <p class="info-card-content">
                Accede al historial m√©dico completo incluyendo alergias y
                condiciones.
              </p>
            </div>
          </div>

          <div class="chart-container">
            <div class="chart-header">
              <h3 class="chart-title">Estad√≠sticas Generales</h3>
              <select class="filter-dropdown" id="stats-period-filter">
                <option value="week">Esta semana</option>
                <option value="month">Este mes</option>
                <option value="year">Este a√±o</option>
              </select>
            </div>
            <div id="general-stats-content">
              <div class="loading">Cargando estad√≠sticas...</div>
            </div>
          </div>
        </div>

        <!-- Search View -->
        <div id="search-view" class="view">
          <div class="chart-container">
            <h3 class="chart-title" style="margin-bottom: 1.5rem">
              B√∫squeda Avanzada de Pacientes
            </h3>

            <div class="tabs">
              <button class="tab active" onclick="switchTab('profile-search')">
                Por Perfil
              </button>
              <button class="tab" onclick="switchTab('medical-search')">
                Por Patr√≥n M√©dico
              </button>
              <button class="tab" onclick="switchTab('staff-search')">
                Personal M√©dico
              </button>
            </div>

            <!-- Profile Search Tab -->
            <div id="profile-search-tab" class="tab-content active">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Rango de Edad</label>
                  <div style="display: flex; gap: 0.5rem">
                    <input
                      type="number"
                      class="form-control"
                      id="age-min"
                      placeholder="M√≠n"
                    />
                    <input
                      type="number"
                      class="form-control"
                      id="age-max"
                      placeholder="M√°x"
                    />
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">G√©nero</label>
                  <select class="form-control" id="gender-filter">
                    <option value="">Todos</option>
                    <option value="M">Masculino</option>
                    <option value="F">Femenino</option>
                    <option value="O">Otro</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Nivel de Actividad</label>
                  <select class="form-control" id="activity-filter">
                    <option value="">Todos</option>
                    <option value="sedentario">Sedentario</option>
                    <option value="ligero">Ligero</option>
                    <option value="moderado">Moderado</option>
                    <option value="activo">Activo</option>
                    <option value="muy_activo">Muy Activo</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-primary" onclick="searchByProfile()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  />
                </svg>
                Buscar
              </button>
            </div>

            <!-- Medical Pattern Search Tab -->
            <div id="medical-search-tab" class="tab-content">
              <div class="form-group">
                <label class="form-label">Condici√≥n M√©dica</label>
                <input
                  type="text"
                  class="form-control"
                  id="medical-condition"
                  placeholder="Ej: diabetes, hipertensi√≥n"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Alergia</label>
                <input
                  type="text"
                  class="form-control"
                  id="allergy-search"
                  placeholder="Ej: lactosa, gluten"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Medicamento</label>
                <input
                  type="text"
                  class="form-control"
                  id="medication-search"
                  placeholder="Ej: metformina, insulina"
                />
              </div>
              <button
                class="btn btn-primary"
                onclick="searchByMedicalPattern()"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  />
                </svg>
                Buscar
              </button>
            </div>

            <!-- Staff Search Tab -->
            <div id="staff-search-tab" class="tab-content">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Nombre</label>
                  <input
                    type="text"
                    class="form-control"
                    id="staff-name"
                    placeholder="Buscar por nombre"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Especialidad</label>
                  <input
                    type="text"
                    class="form-control"
                    id="staff-specialty"
                    placeholder="Ej: Nutrici√≥n, Endocrinolog√≠a"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Tipo</label>
                  <select class="form-control" id="staff-type">
                    <option value="">Todos</option>
                    <option value="doctor">Doctores</option>
                    <option value="admin">Administradores</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-primary" onclick="searchStaff()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  />
                </svg>
                Buscar
              </button>
            </div>
          </div>

          <!-- Search Results -->
          <div
            id="search-results"
            class="table-container"
            style="display: none; margin-top: 1.5rem"
          >
            <div class="table-header">
              <h3 class="table-title" id="search-results-title">
                Resultados de B√∫squeda
              </h3>
              <span
                id="search-results-count"
                style="color: #6b7280; font-size: 0.875rem"
              ></span>
            </div>
            <div id="search-results-content"></div>
          </div>
        </div>
      </main>
    </div>

    <!-- Patient Details Modal -->
    <div id="patient-details-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Informaci√≥n del Paciente</h3>
          <button
            class="modal-close"
            onclick="closeModal('patient-details-modal')"
          >
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="tabs">
            <button class="tab active" onclick="switchPatientTab('info')">
              Informaci√≥n General
            </button>
            <button class="tab" onclick="switchPatientTab('medical')">
              Historial M√©dico
            </button>
            <button class="tab" onclick="switchPatientTab('nutrition')">
              Informaci√≥n Nutricional
            </button>
            <button class="tab" onclick="switchPatientTab('activity')">
              Actividad F√≠sica
            </button>
            <button class="tab" onclick="switchPatientTab('recommendations')">
              Recomendaciones IA
            </button>
          </div>

          <!-- Info Tab -->
          <div id="patient-info-tab" class="tab-content active">
            <div class="detail-grid" id="patient-info-content">
              <div class="loading">Cargando informaci√≥n...</div>
            </div>
          </div>

          <!-- Medical History Tab -->
          <div id="patient-medical-tab" class="tab-content">
            <div id="patient-medical-content">
              <div class="loading">Cargando historial m√©dico...</div>
            </div>
          </div>

          <!-- Nutrition Tab -->
          <div id="patient-nutrition-tab" class="tab-content">
            <div id="patient-nutrition-content">
              <div class="loading">Cargando informaci√≥n nutricional...</div>
            </div>
          </div>

          <!-- Activity Tab -->
          <div id="patient-activity-tab" class="tab-content">
            <div id="patient-activity-content">
              <div class="loading">Cargando actividad f√≠sica...</div>
            </div>
          </div>

          <!-- Recommendations Tab -->
          <div id="patient-recommendations-tab" class="tab-content">
            <div id="patient-recommendations-content">
              <div class="loading">Cargando recomendaciones...</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('patient-details-modal')"
          >
            Cerrar
          </button>
          <button class="btn btn-primary" onclick="generateNewRecommendation()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
              />
            </svg>
            Generar Nueva Recomendaci√≥n
          </button>
        </div>
      </div>
    </div>

    <script>
      // State management

      let currentView = 'dashboard';
      let currentPatientId = null;
      let currentDoctorId = null;
      let allPatients = [];
      let allDoctors = [];
      let allAdmins = [];
      let currentAdminInfo = null;

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        setupNavigation();
        updateDateTime();
        setInterval(updateDateTime, 60000); // Update every minute
        loadDashboard();
        loadCharts();
      });

      // Navigation
      function setupNavigation() {
        document.querySelectorAll('.nav-link').forEach((link) => {
          link.addEventListener('click', (e) => {
            if (link.getAttribute('href')) return;

            e.preventDefault();
            const view = link.dataset.view;
            if (view) {
              switchView(view);

              document
                .querySelectorAll('.nav-link')
                .forEach((l) => l.classList.remove('active'));
              link.classList.add('active');
            }
          });
        });
      }

      function switchView(view) {
        currentView = view;

        document
          .querySelectorAll('.view')
          .forEach((v) => v.classList.remove('active'));
        document.getElementById(`${view}-view`).classList.add('active');

        if (view === 'dashboard') {
          loadDashboard();
          loadCharts();
        }
        if (view === 'admins') loadAdmins();
        if (view === 'doctors') loadDoctors();
        if (view === 'patients') loadPatients();
        if (view === 'analytics') loadAnalytics();
        if (view === 'search') loadSearchView();
      }

      function updateDateTime() {
        const now = new Date();
        const hours = now.getHours();

        let greeting = 'Buenos d√≠as';
        if (hours >= 12 && hours < 19) greeting = 'Buenas tardes';
        if (hours >= 19) greeting = 'Buenas noches';

        document.getElementById('greeting').textContent =
          `${greeting}, Superusuario`;

        const options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        };
        document.getElementById('current-date').textContent =
          now.toLocaleDateString('es-MX', options);
        document.getElementById('current-time').textContent =
          now.toLocaleTimeString('es-MX', {
            hour: '2-digit',
            minute: '2-digit',
          });
      }

      // API calls
      async function apiCall(endpoint, options = {}) {
        const token = localStorage.getItem('access_token');
        if (!token) {
          window.location.href = '/auth/login';
          return;
        }

        const defaultOptions = {
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
        };

        try {
          const response = await fetch(endpoint, {
            ...defaultOptions,
            ...options,
          });

          if (response.status === 401) {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/auth/login';
            return null;
          }

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Error en la solicitud');
          }

          return await response.json();
        } catch (error) {
          console.error('API Error:', error);
          alert(error.message || 'Error al conectar con el servidor');
          throw error;
        }
      }

      // Dashboard
      async function loadDashboard() {
        try {
          const stats = await apiCall('/dashboard/stats');
          const registrations = await apiCall('/dashboard/registros-recientes');

          // Update stats
          document.getElementById('stat-total-admins').textContent =
            stats.resumen.totalAdmins;
          document.getElementById('stat-total-doctors').textContent =
            stats.resumen.totalDoctores;
          document.getElementById('stat-total-patients').textContent =
            stats.resumen.totalUsuarios;
          document.getElementById('stat-active-patients').textContent =
            stats.resumen.usuariosActivos;
          document.getElementById('stat-doctors-growth').textContent =
            `+${stats.crecimiento.nuevosDoctores} esta semana`;
          document.getElementById('stat-patients-growth').textContent =
            `+${stats.crecimiento.nuevosUsuarios} esta semana`;

          // Update admin profile sidebar
          document.getElementById('admin-doctors-count').textContent =
            stats.resumen.totalDoctores;
          document.getElementById('admin-patients-count').textContent =
            stats.resumen.totalUsuarios;

          // Update recent registrations
          const tbody = document.getElementById('recent-registrations');
          if (
            !registrations.ultimosUsuarios.length &&
            !registrations.ultimosDoctores.length
          ) {
            tbody.innerHTML =
              '<tr><td colspan="4" class="empty-state">No hay registros recientes</td></tr>';
            return;
          }

          const allRegistrations = [
            ...registrations.ultimosUsuarios.map((u) => ({
              ...u,
              tipo: 'Paciente',
            })),
            ...registrations.ultimosDoctores.map((d) => ({
              ...d,
              tipo: 'Doctor',
            })),
          ]
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .slice(0, 10);

          tbody.innerHTML = allRegistrations
            .map(
              (reg) => `
                    <tr>
                        <td><span class="badge ${reg.tipo === 'Paciente' ? 'badge-info' : 'badge-success'}">${reg.tipo}</span></td>
                        <td>${reg.nombre}</td>
                        <td>${reg.email}</td>
                        <td>${new Date(reg.created_at).toLocaleDateString('es-MX')}</td>
                    </tr>
                `,
            )
            .join('');
        } catch (error) {
          console.error('Error loading dashboard:', error);
        }
      }

      // Charts
      async function loadCharts() {
        try {
          // Simular datos de las gr√°ficas (en un caso real, estos vendr√≠an de APIs)
          const chartsData = {
            patientsPerDoctor: [
              { doctor: 'Dr. Garc√≠a', patients: 45 },
              { doctor: 'Dra. Mart√≠nez', patients: 38 },
              { doctor: 'Dr. Rodr√≠guez', patients: 52 },
              { doctor: 'Dra. L√≥pez', patients: 29 },
              { doctor: 'Dr. Hern√°ndez', patients: 41 },
              { doctor: 'Dra. Gonz√°lez', patients: 35 },
              { doctor: 'Dr. P√©rez', patients: 47 },
            ],
            usersEvolution: [
              { month: 'Ene', users: 120 },
              { month: 'Feb', users: 145 },
              { month: 'Mar', users: 168 },
              { month: 'Abr', users: 192 },
              { month: 'May', users: 210 },
              { month: 'Jun', users: 235 },
              { month: 'Jul', users: 258 },
              { month: 'Ago', users: 280 },
              { month: 'Sep', users: 305 },
            ],
            doctorsSpecialties: [
              { specialty: 'Nutrici√≥n', count: 12 },
              { specialty: 'Endocrinolog√≠a', count: 8 },
              { specialty: 'Medicina General', count: 15 },
              { specialty: 'Pediatr√≠a', count: 6 },
              { specialty: 'Geriatr√≠a', count: 4 },
            ],
            doctorsActivity: [
              { doctor: 'Dr. Garc√≠a', consultations: 125 },
              { doctor: 'Dra. Mart√≠nez', consultations: 98 },
              { doctor: 'Dr. Rodr√≠guez', consultations: 142 },
              { doctor: 'Dra. L√≥pez', consultations: 87 },
              { doctor: 'Dr. Hern√°ndez', consultations: 113 },
              { doctor: 'Dra. Gonz√°lez', consultations: 76 },
              { doctor: 'Dr. P√©rez', consultations: 134 },
            ],
            genderDistribution: [
              { gender: 'Masculino', count: 165 },
              { gender: 'Femenino', count: 192 },
              { gender: 'Otro', count: 18 },
            ],
          };

          // Renderizar gr√°ficas
          renderBarChart(
            'patients-per-doctor-chart',
            chartsData.patientsPerDoctor,
            'patients',
            'doctor',
          );
          renderLineChart(
            'users-evolution-chart',
            chartsData.usersEvolution,
            'users',
            'month',
          );
          renderPieChart(
            'doctors-specialties-chart',
            chartsData.doctorsSpecialties,
            'specialty',
          );
          renderBarChart(
            'doctors-activity-chart',
            chartsData.doctorsActivity,
            'consultations',
            'doctor',
          );
          renderPieChart(
            'gender-distribution-chart',
            chartsData.genderDistribution,
            'gender',
          );
        } catch (error) {
          console.error('Error loading charts:', error);
        }
      }

      function renderBarChart(containerId, data, valueField, labelField) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Encontrar el valor m√°ximo para escalar las barras
        const maxValue = Math.max(...data.map((item) => item[valueField]));

        container.innerHTML = `
                <div class="bar-chart">
                    ${data
                      .map(
                        (item) => `
                        <div class="bar-container">
                            <div class="bar" style="height: ${(item[valueField] / maxValue) * 100}%">
                                <div class="bar-value">${item[valueField]}</div>
                            </div>
                            <div class="bar-label">${item[labelField]}</div>
                        </div>
                    `,
                      )
                      .join('')}
                </div>
            `;
      }

      function renderLineChart(containerId, data, valueField, labelField) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Crear un SVG para la gr√°fica de l√≠neas
        const width = 600;
        const height = 200;
        const padding = 40;

        const values = data.map((item) => item[valueField]);
        const maxValue = Math.max(...values);
        const minValue = Math.min(...values);

        // Calcular puntos para la l√≠nea
        const xStep = (width - 2 * padding) / (data.length - 1);
        const yScale = (height - 2 * padding) / (maxValue - minValue);

        let pathData = `M ${padding} ${height - padding - (values[0] - minValue) * yScale}`;

        for (let i = 1; i < data.length; i++) {
          const x = padding + i * xStep;
          const y = height - padding - (values[i] - minValue) * yScale;
          pathData += ` L ${x} ${y}`;
        }

        // Crear √°rea bajo la curva
        let areaData = `${pathData} L ${padding + (data.length - 1) * xStep} ${height - padding} L ${padding} ${height - padding} Z`;

        container.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                    <!-- Eje X -->
                    <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#e5e7eb" stroke-width="1" />
                    
                    <!-- Eje Y -->
                    <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#e5e7eb" stroke-width="1" />
                    
                    <!-- √Årea bajo la curva -->
                    <path d="${areaData}" fill="rgba(16, 185, 129, 0.1)" />
                    
                    <!-- L√≠nea de la gr√°fica -->
                    <path d="${pathData}" fill="none" stroke="#10b981" stroke-width="3" />
                    
                    <!-- Puntos -->
                    ${data
                      .map((item, i) => {
                        const x = padding + i * xStep;
                        const y =
                          height - padding - (values[i] - minValue) * yScale;
                        return `<circle cx="${x}" cy="${y}" r="4" fill="#10b981" />`;
                      })
                      .join('')}
                    
                    <!-- Etiquetas del eje X -->
                    ${data
                      .map((item, i) => {
                        const x = padding + i * xStep;
                        return `
                            <text x="${x}" y="${height - padding + 15}" text-anchor="middle" font-size="10" fill="#6b7280">${item[labelField]}</text>
                        `;
                      })
                      .join('')}
                    
                    <!-- Etiquetas del eje Y -->
                    <text x="${padding - 10}" y="${padding}" text-anchor="end" font-size="10" fill="#6b7280">${maxValue}</text>
                    <text x="${padding - 10}" y="${height - padding}" text-anchor="end" font-size="10" fill="#6b7280">${minValue}</text>
                </svg>
            `;
      }

      function renderPieChart(containerId, data, labelField) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const total = data.reduce((sum, item) => sum + item.count, 0);
        let cumulativePercent = 0;

        // Colores para las secciones del pastel
        const colors = [
          '#10b981',
          '#34d399',
          '#6ee7b7',
          '#a7f3d0',
          '#d1fae5',
          '#ecfdf5',
        ];

        container.innerHTML = `
                <div class="pie-chart">
                    ${data
                      .map((item, i) => {
                        const percent = (item.count / total) * 100;
                        const startPercent = cumulativePercent;
                        cumulativePercent += percent;

                        return `
                            <div class="pie-segment" style="
                                background: ${colors[i % colors.length]};
                                clip-path: polygon(50% 50%, 
                                    ${50 + 50 * Math.cos((2 * Math.PI * startPercent) / 100)}% ${50 + 50 * Math.sin((2 * Math.PI * startPercent) / 100)}%,
                                    ${50 + 50 * Math.cos((2 * Math.PI * cumulativePercent) / 100)}% ${50 + 50 * Math.sin((2 * Math.PI * cumulativePercent) / 100)}%);
                            "></div>
                        `;
                      })
                      .join('')}
                </div>
                <div class="pie-legend">
                    ${data
                      .map(
                        (item, i) => `
                        <div class="pie-legend-item">
                            <div class="pie-legend-color" style="background: ${colors[i % colors.length]}"></div>
                            <span>${item[labelField]} (${((item.count / total) * 100).toFixed(1)}%)</span>
                        </div>
                    `,
                      )
                      .join('')}
                </div>
            `;
      }

      function downloadChart(chartId) {
        // En una implementaci√≥n real, esto generar√≠a un archivo descargable
        alert(`Exportando gr√°fica: ${chartId}`);
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        setupNavigation();
        updateDateTime();
        setInterval(updateDateTime, 60000); // Update every minute
        loadDashboard();
      });

      // Navigation
      function setupNavigation() {
        document.querySelectorAll('.nav-link').forEach((link) => {
          link.addEventListener('click', (e) => {
            if (link.getAttribute('href')) return;

            e.preventDefault();
            const view = link.dataset.view;
            if (view) {
              switchView(view);

              document
                .querySelectorAll('.nav-link')
                .forEach((l) => l.classList.remove('active'));
              link.classList.add('active');
            }
          });
        });

        // Search functionality
        document
          .getElementById('patient-search')
          ?.addEventListener('input', (e) => {
            filterPatients(e.target.value);
          });

        document
          .getElementById('doctor-search')
          ?.addEventListener('input', (e) => {
            filterDoctors(e.target.value);
          });
      }

      function switchView(view) {
        currentView = view;

        document
          .querySelectorAll('.view')
          .forEach((v) => v.classList.remove('active'));
        document.getElementById(`${view}-view`).classList.add('active');

        if (view === 'admins') loadAdmins();
        if (view === 'doctors') loadDoctors();
        if (view === 'patients') loadPatients();
        if (view === 'analytics') loadAnalytics();
        if (view === 'search') loadSearchView();
      }

      function updateDateTime() {
        const now = new Date();
        const hours = now.getHours();

        let greeting = 'Buenos d√≠as';
        if (hours >= 12 && hours < 19) greeting = 'Buenas tardes';
        if (hours >= 19) greeting = 'Buenas noches';

        document.getElementById('greeting').textContent =
          `${greeting}, Superusuario`;

        const options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        };
        document.getElementById('current-date').textContent =
          now.toLocaleDateString('es-MX', options);
        document.getElementById('current-time').textContent =
          now.toLocaleTimeString('es-MX', {
            hour: '2-digit',
            minute: '2-digit',
          });
      }

      function getBackendConfig() {
        return {
          host: localStorage.getItem('backend_host') || 'localhost',
          port: localStorage.getItem('backend_port') || '4000',
          protocol: localStorage.getItem('backend_protocol') || 'http',
          timeout: localStorage.getItem('backend_timeout') || '5000',
          healthEndpoint:
            localStorage.getItem('health_endpoint') || '/auth/health',
          retryAttempts: localStorage.getItem('retry_attempts') || '3',
        };
      }

      function getBackendBaseUrl() {
        const config = getBackendConfig();
        return `${config.protocol}://${config.host}:${config.port}`;
      }

      function getHealthCheckUrl() {
        const config = getBackendConfig();
        const baseUrl = getBackendBaseUrl();
        return `${baseUrl}${config.healthEndpoint}`;
      }

      function loadBackendConfig() {
        const config = getBackendConfig();

        // Actualizar campos del formulario
        document.getElementById('backend-host').value = config.host;
        document.getElementById('backend-port').value = config.port;
        document.getElementById('backend-protocol').value = config.protocol;
        document.getElementById('backend-timeout').value = config.timeout;
        document.getElementById('health-endpoint').value =
          config.healthEndpoint;
        document.getElementById('retry-attempts').value = config.retryAttempts;

        // Actualizar configuraci√≥n actual mostrada
        document.getElementById('current-backend-url').textContent =
          getBackendBaseUrl();
        document.getElementById('backend-url').textContent =
          `${config.host}:${config.port}`;
      }

      function saveBackendConfig() {
        const host = document.getElementById('backend-host').value.trim();
        const port = document.getElementById('backend-port').value;
        const protocol = document.getElementById('backend-protocol').value;
        const timeout = document.getElementById('backend-timeout').value;
        const healthEndpoint = document
          .getElementById('health-endpoint')
          .value.trim();
        const retryAttempts = document.getElementById('retry-attempts').value;

        // Validaciones b√°sicas
        if (!host) {
          alert('Por favor, ingrese un host v√°lido');
          return;
        }

        if (!port || port < 1 || port > 65535) {
          alert('Por favor, ingrese un puerto v√°lido (1-65535)');
          return;
        }

        if (!healthEndpoint.startsWith('/')) {
          alert('El endpoint de health check debe comenzar con /');
          return;
        }

        // Guardar en localStorage
        localStorage.setItem('backend_host', host);
        localStorage.setItem('backend_port', port);
        localStorage.setItem('backend_protocol', protocol);
        localStorage.setItem('backend_timeout', timeout);
        localStorage.setItem('health_endpoint', healthEndpoint);
        localStorage.setItem('retry_attempts', retryAttempts);

        alert('Configuraci√≥n del backend guardada correctamente');
        loadBackendConfig(); // Actualizar la UI
        runHealthCheck(); // Probar la nueva configuraci√≥n
      }

      function resetBackendConfig() {
        if (
          confirm(
            '¬øEst√° seguro de que desea restablecer la configuraci√≥n del backend a los valores predeterminados?',
          )
        ) {
          localStorage.removeItem('backend_host');
          localStorage.removeItem('backend_port');
          localStorage.removeItem('backend_protocol');
          localStorage.removeItem('backend_timeout');
          localStorage.removeItem('health_endpoint');
          localStorage.removeItem('retry_attempts');

          loadBackendConfig();
          alert('Configuraci√≥n restablecida a valores predeterminados');
        }
      }

      async function testBackendConnection() {
        const testButton = document.querySelector(
          '.config-actions .btn-secondary',
        );
        const originalText = testButton.innerHTML;

        // Mostrar estado de prueba
        testButton.innerHTML =
          '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Probando...';
        testButton.disabled = true;

        try {
          const healthUrl = getHealthCheckUrl();
          const config = getBackendConfig();

          const controller = new AbortController();
          const timeoutId = setTimeout(
            () => controller.abort(),
            parseInt(config.timeout),
          );

          const startTime = performance.now();
          const response = await fetch(healthUrl, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);
          const endTime = performance.now();
          const responseTime = Math.round(endTime - startTime);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          alert(
            `‚úÖ Conexi√≥n exitosa\n\nURL: ${healthUrl}\nTiempo de respuesta: ${responseTime}ms\nEstado: ${data.status || 'OK'}`,
          );
        } catch (error) {
          let errorMessage = 'Error desconocido';

          if (error.name === 'AbortError') {
            errorMessage = `Timeout: El servidor no respondi√≥ en ${config.timeout}ms`;
          } else if (
            error.name === 'TypeError' &&
            error.message.includes('fetch')
          ) {
            errorMessage = 'Error de red: No se puede conectar al servidor';
          } else {
            errorMessage = error.message;
          }

          alert(
            `‚ùå Error de conexi√≥n\n\nURL: ${getHealthCheckUrl()}\nError: ${errorMessage}`,
          );
        } finally {
          // Restaurar bot√≥n
          testButton.innerHTML = originalText;
          testButton.disabled = false;
        }
      }

      function showBackendConfig() {
        document.getElementById('backend-config-section').style.display =
          'block';
        loadBackendConfig();
      }

      function hideBackendConfig() {
        document.getElementById('backend-config-section').style.display =
          'none';
      }

      function switchConfigTab(tabName) {
        // Ocultar todas las pesta√±as
        document.querySelectorAll('.config-tab-content').forEach((tab) => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.config-tab').forEach((tab) => {
          tab.classList.remove('active');
        });

        // Mostrar pesta√±a seleccionada
        document
          .getElementById(`${tabName}-config-tab`)
          .classList.add('active');
        event.target.classList.add('active');
      }
      const baseUrl = getBackendBaseUrl();
      async function runHealthCheck() {
        const statusIndicator = document.getElementById(
          'health-status-indicator',
        );
        const statusText = document.getElementById('health-status-text');
        const responseTime = document.getElementById('response-time');
        const lastCheck = document.getElementById('last-check');
        const apiStatus = document.getElementById('api-status');
        const healthDetails = document.getElementById('health-details');
        const healthDetailsContent = document.getElementById(
          'health-details-content',
        );

        // Verificar que todos los elementos existan
        if (
          !statusIndicator ||
          !statusText ||
          !responseTime ||
          !lastCheck ||
          !apiStatus ||
          !healthDetails ||
          !healthDetailsContent
        ) {
          console.error('Elementos del health check no encontrados');
          return;
        }

        // Mostrar estado de carga
        statusIndicator.className = 'status-indicator';
        statusText.className = 'status-text';

        statusIndicator.classList.add('warning');
        statusText.classList.add('warning');
        statusText.textContent = 'Verificando...';
        responseTime.textContent = '...';
        lastCheck.textContent = '...';
        apiStatus.textContent = 'Verificando...';
        healthDetails.style.display = 'none';

        try {
          const startTime = performance.now();

          // Verificar backend en localhost:4000/auth/health
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);

          const response = await fetch(`${baseUrl}/auth/health`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          const endTime = performance.now();
          const responseTimeMs = Math.round(endTime - startTime);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const healthData = await response.json();

          // Actualizar UI con resultados
          if (healthData.status === 'OK') {
            statusIndicator.className = 'status-indicator healthy';
            statusText.className = 'status-text healthy';
            statusText.textContent = 'Sistema Saludable';
          } else {
            statusIndicator.className = 'status-indicator warning';
            statusText.className = 'status-text warning';
            statusText.textContent = 'Advertencia';
          }

          // Remov√≠ dbStatus ya que no existe en el HTML
          responseTime.textContent = `${responseTimeMs}ms`;
          lastCheck.textContent = new Date().toLocaleTimeString('es-MX');
          apiStatus.textContent =
            healthData.status === 'OK' ? 'En l√≠nea' : 'Error';

          // Mostrar detalles t√©cnicos
          healthDetailsContent.textContent = JSON.stringify(
            healthData,
            null,
            2,
          );
          healthDetails.className =
            healthData.status === 'OK'
              ? 'health-check-details'
              : 'health-check-details error';

          console.log('Health check successful:', healthData);
        } catch (error) {
          console.error('Health check failed:', error);

          // Determinar tipo de error
          let errorType = 'Error de Conexi√≥n';
          let errorDetails = 'No se pudo conectar al servidor';

          if (error.name === 'AbortError') {
            errorType = 'Timeout';
            errorDetails = 'El servidor no respondi√≥ en 5 segundos';
          } else if (
            error.name === 'TypeError' &&
            error.message.includes('fetch')
          ) {
            errorType = 'Error de Red';
            errorDetails = 'No se puede alcanzar el servidor backend';
          } else if (error.message.includes('HTTP')) {
            errorType = 'Error HTTP';
            errorDetails = error.message;
          }

          statusIndicator.className = 'status-indicator error';
          statusText.className = 'status-text error';
          statusText.textContent = errorType;

          // Remov√≠ dbStatus ya que no existe en el HTML
          responseTime.textContent = 'N/A';
          lastCheck.textContent = new Date().toLocaleTimeString('es-MX');
          apiStatus.textContent = errorDetails;

          // Mostrar detalles del error
          healthDetailsContent.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
          healthDetails.className = 'health-check-details error';
          healthDetails.style.display = 'block';
        }
      }
      function toggleHealthDetails() {
        const healthDetails = document.getElementById('health-details');
        healthDetails.style.display =
          healthDetails.style.display === 'none' ? 'block' : 'none';
      }

      // Ejecutar health check al cargar la p√°gina
      document.addEventListener('DOMContentLoaded', function () {
        runHealthCheck();
        setInterval(runHealthCheck, 120000);
      });

      // API calls
      async function apiCall(endpoint, options = {}) {
        const token = localStorage.getItem('access_token');
        if (!token) {
          window.location.href = '/auth/login';
          return;
        }

        const defaultOptions = {
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
        };

        try {
          const response = await fetch(endpoint, {
            ...defaultOptions,
            ...options,
          });

          if (response.status === 401) {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/auth/login';
            return null;
          }

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Error en la solicitud');
          }

          return await response.json();
        } catch (error) {
          console.error('API Error:', error);
          alert(error.message || 'Error al conectar con el servidor');
          throw error;
        }
      }

      // Dashboard
      async function loadDashboard() {
        try {
          const stats = await apiCall('/dashboard/stats');
          const registrations = await apiCall('/dashboard/registros-recientes');

          // Update stats
          document.getElementById('stat-total-admins').textContent =
            stats.resumen.totalAdmins;
          document.getElementById('stat-total-doctors').textContent =
            stats.resumen.totalDoctores;
          document.getElementById('stat-total-patients').textContent =
            stats.resumen.totalUsuarios;
          document.getElementById('stat-active-patients').textContent =
            stats.resumen.usuariosActivos;
          document.getElementById('stat-doctors-growth').textContent =
            `+${stats.crecimiento.nuevosDoctores} esta semana`;
          document.getElementById('stat-patients-growth').textContent =
            `+${stats.crecimiento.nuevosUsuarios} esta semana`;

          // Update admin profile sidebar
          document.getElementById('admin-doctors-count').textContent =
            stats.resumen.totalDoctores;
          document.getElementById('admin-patients-count').textContent =
            stats.resumen.totalUsuarios;

          // Update recent registrations
          const tbody = document.getElementById('recent-registrations');
          if (
            !registrations.ultimosUsuarios.length &&
            !registrations.ultimosDoctores.length
          ) {
            tbody.innerHTML =
              '<tr><td colspan="4" class="empty-state">No hay registros recientes</td></tr>';
            return;
          }

          const allRegistrations = [
            ...registrations.ultimosUsuarios.map((u) => ({
              ...u,
              tipo: 'Paciente',
            })),
            ...registrations.ultimosDoctores.map((d) => ({
              ...d,
              tipo: 'Doctor',
            })),
          ]
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .slice(0, 10);

          tbody.innerHTML = allRegistrations
            .map(
              (reg) => `
                    <tr>
                        <td><span class="badge ${reg.tipo === 'Paciente' ? 'badge-info' : 'badge-success'}">${reg.tipo}</span></td>
                        <td>${reg.nombre}</td>
                        <td>${reg.email}</td>
                        <td>${new Date(reg.created_at).toLocaleDateString('es-MX')}</td>
                    </tr>
                `,
            )
            .join('');
        } catch (error) {
          console.error('Error loading dashboard:', error);
        }
      }

      // Admins
      async function loadAdmins() {
        try {
          const [admins, currentAdmin] = await Promise.all([
            apiCall('/dashboard/admins'),
            getCurrentAdmin(),
          ]);

          allAdmins = admins;

          // Show current admin info
          const currentAdminDiv = document.getElementById('current-admin-info');
          if (currentAdmin) {
            currentAdminInfo = currentAdmin;
            currentAdminDiv.innerHTML = `
                        <div class="detail-item">
                            <div class="detail-label">Nombre</div>
                            <div class="detail-value">${currentAdmin.nombre}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${currentAdmin.email}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Doctores Creados</div>
                            <div class="detail-value">${currentAdmin.total_doctores_creados} (${currentAdmin.doctores_activos} activos)</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fecha de Registro</div>
                            <div class="detail-value">${new Date(currentAdmin.created_at).toLocaleDateString('es-MX')}</div>
                        </div>
                    `;

            // Update sidebar profile
            document.getElementById('admin-name').textContent =
              currentAdmin.nombre;
            document.getElementById('admin-avatar').textContent = getInitials(
              currentAdmin.nombre,
            );
          } else {
            currentAdminDiv.innerHTML =
              '<div class="empty-state">No se pudo cargar la informaci√≥n</div>';
          }

          // Show other admins
          const tbody = document.getElementById('admins-table');
          const otherAdmins = admins.filter(
            (a) => a.email !== currentAdmin?.email,
          );

          if (otherAdmins.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="empty-state">No hay otros administradores registrados</td></tr>';
            return;
          }

          tbody.innerHTML = otherAdmins
            .map(
              (admin) => `
                    <tr>
                        <td>
                            <div class="patient-card">
                                <div class="patient-avatar">${getInitials(admin.nombre)}</div>
                                <div class="patient-info">
                                    <h4>${admin.nombre}</h4>
                                    <p>Administrador</p>
                                </div>
                            </div>
                        </td>
                        <td>${admin.email}</td>
                        <td>${admin.total_doctores_creados}</td>
                        <td>
                            <span class="badge ${admin.cuenta_activa ? 'badge-success' : 'badge-danger'}">
                                ${admin.cuenta_activa ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>${new Date(admin.created_at).toLocaleDateString('es-MX')}</td>
                    </tr>
                `,
            )
            .join('');
        } catch (error) {
          document.getElementById('admins-table').innerHTML =
            '<tr><td colspan="5" class="empty-state">Error al cargar administradores</td></tr>';
        }
      }

      async function getCurrentAdmin() {
        try {
          const token = localStorage.getItem('access_token');
          const payload = JSON.parse(atob(token.split('.')[1]));
          const email = payload.email;

          return await apiCall(
            `/dashboard/admins/me/${encodeURIComponent(email)}`,
          );
        } catch (error) {
          console.error('Error getting current admin:', error);
          return null;
        }
      }

      // Doctors
      async function loadDoctors() {
        try {
          const doctors = await apiCall('/dashboard/doctors');
          allDoctors = doctors;
          renderDoctors(doctors);
        } catch (error) {
          document.getElementById('doctors-table').innerHTML =
            '<tr><td colspan="6" class="empty-state">Error al cargar doctores</td></tr>';
        }
      }

      function renderDoctors(doctors) {
        const tbody = document.getElementById('doctors-table');

        if (!doctors || doctors.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="empty-state">No hay doctores registrados</td></tr>';
          return;
        }

        tbody.innerHTML = doctors
          .map(
            (doctor) => `
                <tr>
                    <td>
                        <div class="patient-card">
                            <div class="patient-avatar">${getInitials(doctor.nombre)}</div>
                            <div class="patient-info">
                                <h4>${doctor.nombre}</h4>
                                <p>${doctor.email}</p>
                            </div>
                        </div>
                    </td>
                    <td>${doctor.especialidad || 'N/A'}</td>
                    <td>${doctor.cedula_profesional || 'N/A'}</td>
                    <td>
                        <div style="font-weight: 600; color: #1f2937;">${doctor.total_pacientes}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">${doctor.pacientes_activos} activos</div>
                    </td>
                    <td>
                        <span class="badge ${doctor.cuenta_activa ? 'badge-success' : 'badge-danger'}">
                            ${doctor.cuenta_activa ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="showDoctorPatients('${doctor.id}', '${doctor.nombre}')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            Ver Pacientes
                        </button>
                    </td>
                </tr>
            `,
          )
          .join('');
      }

      function filterDoctors(search) {
        const filtered = allDoctors.filter(
          (d) =>
            d.nombre.toLowerCase().includes(search.toLowerCase()) ||
            d.email.toLowerCase().includes(search.toLowerCase()) ||
            (d.especialidad &&
              d.especialidad.toLowerCase().includes(search.toLowerCase())),
        );
        renderDoctors(filtered);
      }

      function showCreateDoctorModal() {
        alert(
          'Modal de crear doctor - Usar el modal del HTML original del dashboard de admin',
        );
      }

      async function showDoctorPatients(doctorId, doctorName) {
        try {
          const patients = await apiCall(
            `/dashboard/doctors/${doctorId}/patients`,
          );

          if (!patients || patients.length === 0) {
            alert(`El doctor ${doctorName} no tiene pacientes asignados`);
            return;
          }

          // Aqu√≠ se podr√≠a abrir un modal mostrando los pacientes
          alert(
            `${doctorName} tiene ${patients.length} paciente(s) asignado(s)`,
          );
        } catch (error) {
          alert('Error al cargar pacientes del doctor');
        }
      }

      // Patients
      async function loadPatients() {
        try {
          const patients = await apiCall('/dashboard/patients');
          allPatients = patients;
          renderPatients(patients);
        } catch (error) {
          document.getElementById('patients-table').innerHTML =
            '<tr><td colspan="6" class="empty-state">Error al cargar pacientes</td></tr>';
        }
      }

      function renderPatients(patients) {
        const tbody = document.getElementById('patients-table');

        if (!patients || patients.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="empty-state">No hay pacientes registrados</td></tr>';
          return;
        }

        tbody.innerHTML = patients
          .map(
            (patient) => `
                <tr>
                    <td>
                        <div class="patient-card">
                            <div class="patient-avatar">${getInitials(patient.nombre)}</div>
                            <div class="patient-info">
                                <h4>${patient.nombre}</h4>
                                <p>${patient.email}</p>
                            </div>
                        </div>
                    </td>
                    <td>${getGenderLabel(patient.genero)}</td>
                    <td>${patient.edad} a√±os</td>
                    <td>
                        <div style="font-weight: 600; color: #1f2937;">${patient.peso_actual || 'N/A'} kg</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Objetivo: ${patient.peso_objetivo || 'N/A'} kg</div>
                    </td>
                    <td>
                        <span class="badge ${patient.cuenta_activa ? 'badge-success' : 'badge-danger'}">
                            ${patient.cuenta_activa ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="showPatientDetails('${patient.id}')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Ver
                            </button>
                        </div>
                    </td>
                </tr>
            `,
          )
          .join('');
      }

      function filterPatients(search) {
        const filtered = allPatients.filter(
          (p) =>
            p.nombre.toLowerCase().includes(search.toLowerCase()) ||
            p.email.toLowerCase().includes(search.toLowerCase()),
        );
        renderPatients(filtered);
      }

      // Patient Details Modal
      async function showPatientDetails(patientId) {
        currentPatientId = patientId;
        openModal('patient-details-modal');

        // Switch to first tab
        switchPatientTab('info');

        // Load patient info
        await loadPatientInfo(patientId);
      }

      async function loadPatientInfo(patientId) {
        try {
          document.getElementById('patient-info-content').innerHTML =
            '<div class="loading">Cargando...</div>';

          const patient = await apiCall(`/dashboard/patients/${patientId}`);

          document.getElementById('patient-info-content').innerHTML = `
                    <div class="detail-item">
                        <div class="detail-label">Nombre Completo</div>
                        <div class="detail-value">${patient.nombre}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${patient.email}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">G√©nero</div>
                        <div class="detail-value">${getGenderLabel(patient.genero)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Edad</div>
                        <div class="detail-value">${patient.edad} a√±os</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Altura</div>
                        <div class="detail-value">${patient.altura} cm</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Peso Actual</div>
                        <div class="detail-value">${patient.peso_actual ? patient.peso_actual + ' kg' : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Peso Objetivo</div>
                        <div class="detail-value">${patient.peso_objetivo ? patient.peso_objetivo + ' kg' : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Nivel de Actividad</div>
                        <div class="detail-value">${patient.nivel_actividad || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Tel√©fono</div>
                        <div class="detail-value">${patient.telefono || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Estado de Cuenta</div>
                        <div class="detail-value">
                            <span class="badge ${patient.cuenta_activa ? 'badge-success' : 'badge-danger'}">
                                ${patient.cuenta_activa ? 'Activa' : 'Inactiva'}
                            </span>
                        </div>
                    </div>
                `;
        } catch (error) {
          document.getElementById('patient-info-content').innerHTML =
            '<div class="empty-state">Error al cargar informaci√≥n del paciente</div>';
        }
      }

      async function loadPatientMedicalHistory(patientId) {
        try {
          document.getElementById('patient-medical-content').innerHTML =
            '<div class="loading">Cargando...</div>';

          const history = await apiCall(
            `/api/historial-medico/completo/${patientId}`,
          );

          let content = '<div style="margin-bottom: 1.5rem;">';

          if (history.alergias && history.alergias.length > 0) {
            content += `
                        <h4 style="color: #1f2937; margin-bottom: 0.75rem; font-size: 1rem;">Alergias</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                            ${history.alergias.map((a) => `<span class="badge badge-danger">${a}</span>`).join('')}
                        </div>
                    `;
          }

          if (
            history.condiciones_medicas &&
            history.condiciones_medicas.length > 0
          ) {
            content += `
                        <h4 style="color: #1f2937; margin-bottom: 0.75rem; font-size: 1rem;">Condiciones M√©dicas</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                            ${history.condiciones_medicas.map((c) => `<span class="badge badge-warning">${c}</span>`).join('')}
                        </div>
                    `;
          }

          if (history.medicamentos && history.medicamentos.length > 0) {
            content += `
                        <h4 style="color: #1f2937; margin-bottom: 0.75rem; font-size: 1rem;">Medicamentos</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${history.medicamentos.map((m) => `<span class="badge badge-info">${m}</span>`).join('')}
                        </div>
                    `;
          }

          content += '</div>';

          if (
            !history.alergias?.length &&
            !history.condiciones_medicas?.length &&
            !history.medicamentos?.length
          ) {
            content =
              '<div class="empty-state">No hay historial m√©dico registrado</div>';
          }

          document.getElementById('patient-medical-content').innerHTML =
            content;
        } catch (error) {
          document.getElementById('patient-medical-content').innerHTML =
            '<div class="empty-state">Error al cargar historial m√©dico</div>';
        }
      }

      async function loadPatientNutrition(patientId) {
        try {
          document.getElementById('patient-nutrition-content').innerHTML =
            '<div class="loading">Cargando...</div>';

          const nutrition = await apiCall(`/api/consumo-mensual/${patientId}`);

          let content = `
                    <div class="detail-grid" style="margin-bottom: 1.5rem;">
                        <div class="detail-item">
                            <div class="detail-label">Calor√≠as Promedio Diarias</div>
                            <div class="detail-value">${nutrition.promedio_calorias || 'N/A'} kcal</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Prote√≠nas</div>
                            <div class="detail-value">${nutrition.promedio_proteinas || 'N/A'} g</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Carbohidratos</div>
                            <div class="detail-value">${nutrition.promedio_carbohidratos || 'N/A'} g</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Grasas</div>
                            <div class="detail-value">${nutrition.promedio_grasas || 'N/A'} g</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Comidas Registradas</div>
                            <div class="detail-value">${nutrition.total_comidas || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">D√≠as con Registro</div>
                            <div class="detail-value">${nutrition.dias_con_registro || 0}</div>
                        </div>
                    </div>
                `;

          if (
            nutrition.comidas_recientes &&
            nutrition.comidas_recientes.length > 0
          ) {
            content += `
                        <h4 style="color: #1f2937; margin-bottom: 0.75rem; font-size: 1rem;">Comidas Recientes</h4>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Calor√≠as</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${nutrition.comidas_recientes
                                  .map(
                                    (c) => `
                                    <tr>
                                        <td>${new Date(c.fecha).toLocaleDateString('es-MX')}</td>
                                        <td>${c.tipo_comida}</td>
                                        <td>${c.calorias_totales} kcal</td>
                                    </tr>
                                `,
                                  )
                                  .join('')}
                            </tbody>
                        </table>
                    `;
          }

          document.getElementById('patient-nutrition-content').innerHTML =
            content;
        } catch (error) {
          document.getElementById('patient-nutrition-content').innerHTML =
            '<div class="empty-state">Error al cargar informaci√≥n nutricional</div>';
        }
      }

      async function loadPatientActivity(patientId) {
        try {
          document.getElementById('patient-activity-content').innerHTML =
            '<div class="loading">Cargando...</div>';

          const activities = await apiCall(`/api/actividades/${patientId}`);

          if (!activities || activities.length === 0) {
            document.getElementById('patient-activity-content').innerHTML =
              '<div class="empty-state">No hay actividades f√≠sicas registradas</div>';
            return;
          }

          const content = `
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Actividad</th>
                                <th>Duraci√≥n</th>
                                <th>Calor√≠as</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities
                              .map(
                                (a) => `
                                <tr>
                                    <td>${new Date(a.fecha).toLocaleDateString('es-MX')}</td>
                                    <td>${a.tipo_actividad}</td>
                                    <td>${a.duracion_minutos} min</td>
                                    <td>${a.calorias_quemadas} kcal</td>
                                </tr>
                            `,
                              )
                              .join('')}
                        </tbody>
                    </table>
                `;

          document.getElementById('patient-activity-content').innerHTML =
            content;
        } catch (error) {
          document.getElementById('patient-activity-content').innerHTML =
            '<div class="empty-state">Error al cargar actividades f√≠sicas</div>';
        }
      }

      async function loadPatientRecommendations(patientId) {
        try {
          document.getElementById('patient-recommendations-content').innerHTML =
            '<div class="loading">Cargando...</div>';

          const recommendations = await apiCall(
            `/api/recomendaciones/${patientId}`,
          );

          if (!recommendations || recommendations.length === 0) {
            document.getElementById(
              'patient-recommendations-content',
            ).innerHTML =
              '<div class="empty-state">No hay recomendaciones generadas por IA</div>';
            return;
          }

          const content = recommendations
            .map(
              (r) => `
                    <div class="info-card" style="margin-bottom: 1rem;">
                        <div class="info-card-header">
                            <div class="info-card-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                            </div>
                            <div style="flex: 1;">
                                <div class="info-card-title">${r.tipo_recomendacion}</div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    ${new Date(r.fecha_generacion).toLocaleDateString('es-MX')}
                                </div>
                            </div>
                        </div>
                        <p class="info-card-content">${r.contenido}</p>
                    </div>
                `,
            )
            .join('');

          document.getElementById('patient-recommendations-content').innerHTML =
            content;
        } catch (error) {
          document.getElementById('patient-recommendations-content').innerHTML =
            '<div class="empty-state">Error al cargar recomendaciones</div>';
        }
      }

      function switchPatientTab(tab) {
        // Update tab buttons
        document
          .querySelectorAll('#patient-details-modal .tab')
          .forEach((t) => t.classList.remove('active'));
        event.target.classList.add('active');

        // Update tab content
        document
          .querySelectorAll('#patient-details-modal .tab-content')
          .forEach((c) => c.classList.remove('active'));
        document.getElementById(`patient-${tab}-tab`).classList.add('active');

        // Load data if needed
        if (tab === 'medical' && currentPatientId) {
          loadPatientMedicalHistory(currentPatientId);
        } else if (tab === 'nutrition' && currentPatientId) {
          loadPatientNutrition(currentPatientId);
        } else if (tab === 'activity' && currentPatientId) {
          loadPatientActivity(currentPatientId);
        } else if (tab === 'recommendations' && currentPatientId) {
          loadPatientRecommendations(currentPatientId);
        }
      }

      // Analytics
      async function loadAnalytics() {
        try {
          const stats = await apiCall('/api/estadisticas-generales');

          let content = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Pacientes con Progreso Positivo</div>
                            <div class="detail-value">${stats.progreso_positivo || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Promedio P√©rdida de Peso</div>
                            <div class="detail-value">${stats.promedio_perdida || 'N/A'} kg</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Recomendaciones Generadas</div>
                            <div class="detail-value">${stats.recomendaciones_generadas || 0}</div>
                        </div>
                    </div>
                `;

          document.getElementById('general-stats-content').innerHTML = content;
        } catch (error) {
          document.getElementById('general-stats-content').innerHTML =
            '<div class="empty-state">Error al cargar estad√≠sticas</div>';
        }
      }

      // Search functionality
      function loadSearchView() {
        // Initialize search view if needed
      }

      function switchTab(tabId) {
        document
          .querySelectorAll('#search-view .tab')
          .forEach((t) => t.classList.remove('active'));
        event.target.classList.add('active');

        document
          .querySelectorAll('#search-view .tab-content')
          .forEach((c) => c.classList.remove('active'));
        document.getElementById(`${tabId}-tab`).classList.add('active');
      }

      async function searchByProfile() {
        try {
          const ageMin = document.getElementById('age-min').value;
          const ageMax = document.getElementById('age-max').value;
          const gender = document.getElementById('gender-filter').value;
          const activity = document.getElementById('activity-filter').value;

          const queryParams = new URLSearchParams();
          if (ageMin) queryParams.append('edad_min', ageMin);
          if (ageMax) queryParams.append('edad_max', ageMax);
          if (gender) queryParams.append('genero', gender);
          if (activity) queryParams.append('nivel_actividad', activity);

          const results = await apiCall(
            `/api/buscar-usuarios-perfil?${queryParams}`,
          );
          displaySearchResults(results, 'B√∫squeda por Perfil');
        } catch (error) {
          alert('Error en la b√∫squeda');
        }
      }

      async function searchByMedicalPattern() {
        try {
          const condition = document.getElementById('medical-condition').value;
          const allergy = document.getElementById('allergy-search').value;
          const medication = document.getElementById('medication-search').value;

          const queryParams = new URLSearchParams();
          if (condition) queryParams.append('condicion', condition);
          if (allergy) queryParams.append('alergia', allergy);
          if (medication) queryParams.append('medicamento', medication);

          const results = await apiCall(
            `/api/buscar-usuarios-medico?${queryParams}`,
          );
          displaySearchResults(results, 'B√∫squeda por Patr√≥n M√©dico');
        } catch (error) {
          alert('Error en la b√∫squeda');
        }
      }

      async function searchStaff() {
        try {
          const name = document.getElementById('staff-name').value;
          const specialty = document.getElementById('staff-specialty').value;
          const type = document.getElementById('staff-type').value;

          const queryParams = new URLSearchParams();
          if (name) queryParams.append('nombre', name);
          if (specialty) queryParams.append('especialidad', specialty);
          if (type) queryParams.append('tipo', type);

          const results = await apiCall(`/api/buscar-staff?${queryParams}`);
          displayStaffResults(results, 'B√∫squeda de Personal M√©dico');
        } catch (error) {
          alert('Error en la b√∫squeda');
        }
      }

      function displaySearchResults(results, title) {
        const container = document.getElementById('search-results');
        const titleEl = document.getElementById('search-results-title');
        const countEl = document.getElementById('search-results-count');
        const contentEl = document.getElementById('search-results-content');

        titleEl.textContent = title;
        countEl.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}`;

        if (results.length === 0) {
          contentEl.innerHTML =
            '<div class="empty-state">No se encontraron resultados</div>';
        } else {
          contentEl.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Paciente</th>
                                <th>G√©nero</th>
                                <th>Edad</th>
                                <th>Nivel Actividad</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results
                              .map(
                                (r) => `
                                <tr>
                                    <td>
                                        <div class="patient-card">
                                            <div class="patient-avatar">${getInitials(r.nombre)}</div>
                                            <div class="patient-info">
                                                <h4>${r.nombre}</h4>
                                                <p>${r.email}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${getGenderLabel(r.genero)}</td>
                                    <td>${r.edad} a√±os</td>
                                    <td>${r.nivel_actividad || 'N/A'}</td>
                                    <td>
                                        <span class="badge ${r.cuenta_activa ? 'badge-success' : 'badge-danger'}">
                                            ${r.cuenta_activa ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="showPatientDetails('${r.id}')">
                                            Ver Detalles
                                        </button>
                                    </td>
                                </tr>
                            `,
                              )
                              .join('')}
                        </tbody>
                    </table>
                `;
        }

        container.style.display = 'block';
      }

      function displayStaffResults(results, title) {
        const container = document.getElementById('search-results');
        const titleEl = document.getElementById('search-results-title');
        const countEl = document.getElementById('search-results-count');
        const contentEl = document.getElementById('search-results-content');

        titleEl.textContent = title;
        countEl.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}`;

        if (results.length === 0) {
          contentEl.innerHTML =
            '<div class="empty-state">No se encontraron resultados</div>';
        } else {
          contentEl.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Especialidad</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results
                              .map(
                                (r) => `
                                <tr>
                                    <td>
                                        <div class="patient-card">
                                            <div class="patient-avatar">${getInitials(r.nombre)}</div>
                                            <div class="patient-info">
                                                <h4>${r.nombre}</h4>
                                                <p>${r.tipo}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${r.email}</td>
                                    <td>
                                        <span class="badge ${r.tipo === 'Doctor' ? 'badge-success' : 'badge-info'}">
                                            ${r.tipo}
                                        </span>
                                    </td>
                                    <td>${r.especialidad || 'N/A'}</td>
                                    <td>
                                        <span class="badge ${r.cuenta_activa ? 'badge-success' : 'badge-danger'}">
                                            ${r.cuenta_activa ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                </tr>
                            `,
                              )
                              .join('')}
                        </tbody>
                    </table>
                `;
        }

        container.style.display = 'block';
      }

      // Utility functions
      function getInitials(name) {
        return name
          .split(' ')
          .map((n) => n[0])
          .join('')
          .toUpperCase()
          .substring(0, 2);
      }

      function getGenderLabel(gender) {
        const labels = { M: 'Masculino', F: 'Femenino', O: 'Otro' };
        return labels[gender] || gender;
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
      }

      function showNewConsultation() {
        alert(
          'Esta funcionalidad es del panel de doctor, no del administrador',
        );
      }

      async function generateNewRecommendation() {
        if (!currentPatientId) return;

        if (
          !confirm(
            '¬øDeseas generar una nueva recomendaci√≥n con IA para este paciente?',
          )
        ) {
          return;
        }

        try {
          await apiCall(`/api/generar-recomendacion/${currentPatientId}`, {
            method: 'POST',
          });

          alert('Recomendaci√≥n generada exitosamente');
          loadPatientRecommendations(currentPatientId);
        } catch (error) {
          alert('Error al generar recomendaci√≥n');
        }
      }

      function logout() {
        if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
          document.cookie =
            'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          document.cookie =
            'refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          window.location.href = '/auth/login';
        }
      }

      // Close modal when clicking outside
      document.querySelectorAll('.modal').forEach((modal) => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
          }
        });
      });
    </script>
  </body>
</html>
