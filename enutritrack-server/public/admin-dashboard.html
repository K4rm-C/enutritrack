<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - Sistema de Salud</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #4e73df;
        --secondary-color: #858796;
        --success-color: #1cc88a;
        --info-color: #36b9cc;
        --warning-color: #f6c23e;
        --danger-color: #e74a3b;
        --dark-color: #5a5c69;
        --light-color: #f8f9fc;
      }

      .quick-action-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 15px;
        cursor: pointer;
      }

      .quick-action-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }

      .stats-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      }

      .recent-item {
        border-left: 3px solid var(--primary-color);
        padding-left: 1rem;
        transition: all 0.3s ease;
      }

      .recent-item:hover {
        background-color: #f8f9fc;
        transform: translateX(5px);
      }
    </style>
  </head>
  <body class="dashboard-body">
    <!-- Navbar (igual que antes) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/admins/dashboard">
          <i class="fas fa-heartbeat me-2"></i>
          <strong>Sistema de Salud</strong>
        </a>
        <div class="navbar-nav ms-auto align-items-center">
          <div class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle text-white"
              href="#"
              id="userDropdown"
              role="button"
              data-bs-toggle="dropdown"
            >
              <i class="fas fa-user-circle me-1"></i>
              <span id="user-name">Administrador</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="/admins/profile"
                  ><i class="fas fa-user me-2"></i>Mi Perfil</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item text-danger" href="#" id="logout-btn"
                  ><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar (actualizado) -->
        <nav class="col-md-3 col-lg-2 sidebar bg-dark text-white">
          <div class="position-sticky pt-4">
            <div class="sidebar-header text-center mb-4">
              <h5 class="text-warning">Panel de Control</h5>
            </div>
            <ul class="nav flex-column">
              <li class="nav-item mb-2">
                <a class="nav-link active" href="/admins/dashboard">
                  <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
              </li>
              <li class="nav-item mb-2">
                <a class="nav-link" href="/doctors/management">
                  <i class="fas fa-user-md me-2"></i>Gestión de Doctores
                </a>
              </li>
              <li class="nav-item mb-2">
                <a class="nav-link" href="/users/management">
                  <i class="fas fa-users me-2"></i>Gestión de Usuarios
                </a>
              </li>
              <li class="nav-item mb-2">
                <a class="nav-link" href="/admins/reports">
                  <i class="fas fa-chart-bar me-2"></i>Reportes
                </a>
              </li>
              <li class="nav-item mb-2">
                <a class="nav-link" href="/admins/profile">
                  <i class="fas fa-cog me-2"></i>Configuración
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Main Content (mejorado) -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-4 main-content">
          <!-- Header -->
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom"
          >
            <h1 class="h2 text-primary">
              <i class="fas fa-tachometer-alt me-2"></i>Dashboard Administrativo
            </h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <span
                class="btn btn-sm btn-outline-secondary"
                id="current-date"
              ></span>
            </div>
          </div>

          <!-- Acciones Rápidas -->
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="text-muted mb-3">
                <i class="fas fa-bolt me-2"></i>Acciones Rápidas
              </h5>
              <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                  <div
                    class="card quick-action-card bg-primary text-white"
                    onclick="window.location.href='/doctors/management'"
                  >
                    <div class="card-body text-center">
                      <i class="fas fa-user-md fa-2x mb-3"></i>
                      <h6>Gestión de Doctores</h6>
                      <small>Administrar profesionales</small>
                    </div>
                  </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                  <div
                    class="card quick-action-card bg-success text-white"
                    onclick="window.location.href='/users/management'"
                  >
                    <div class="card-body text-center">
                      <i class="fas fa-users fa-2x mb-3"></i>
                      <h6>Gestión de Usuarios</h6>
                      <small>Administrar pacientes</small>
                    </div>
                  </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                  <div
                    class="card quick-action-card bg-warning text-white"
                    onclick="window.location.href='/admins/reports'"
                  >
                    <div class="card-body text-center">
                      <i class="fas fa-chart-bar fa-2x mb-3"></i>
                      <h6>Reportes</h6>
                      <small>Estadísticas del sistema</small>
                    </div>
                  </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                  <div
                    class="card quick-action-card bg-info text-white"
                    onclick="window.location.href='/admins/analytics'"
                  >
                    <div class="card-body text-center">
                      <i class="fas fa-chart-line fa-2x mb-3"></i>
                      <h6>Analíticas</h6>
                      <small>Métricas de salud</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Estadísticas Principales (mejoradas) -->
          <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card stats-card bg-primary text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h6 class="card-title">TOTAL DOCTORES</h6>
                      <h2 class="mb-0" id="total-doctors">0</h2>
                      <small id="doctors-change" class="text-white-50"
                        >+0 esta semana</small
                      >
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-user-md fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card stats-card bg-success text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h6 class="card-title">TOTAL USUARIOS</h6>
                      <h2 class="mb-0" id="total-users">0</h2>
                      <small id="users-change" class="text-white-50"
                        >+0 esta semana</small
                      >
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-users fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card stats-card bg-warning text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h6 class="card-title">REGISTROS HOY</h6>
                      <h2 class="mb-0" id="today-records">0</h2>
                      <small class="text-white-50">Actividad del día</small>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-clipboard-list fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card stats-card bg-info text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h6 class="card-title">PROMEDIO IMC</h6>
                      <h2 class="mb-0" id="avg-bmi">0</h2>
                      <small class="text-white-50">Salud general</small>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-weight fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Usuarios Recientes (mejorado) -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm">
                <div
                  class="card-header bg-white d-flex justify-content-between align-items-center"
                >
                  <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2 text-success"></i>Usuarios
                    Recientes
                  </h5>
                  <a href="/users/management" class="btn btn-sm btn-success"
                    >Ver Todos</a
                  >
                </div>
                <div class="card-body">
                  <div id="recent-users">
                    <!-- Se carga dinámicamente -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Doctores Recientes (mejorado) -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow-sm">
                <div
                  class="card-header bg-white d-flex justify-content-between align-items-center"
                >
                  <h5 class="card-title mb-0">
                    <i class="fas fa-user-md me-2 text-primary"></i>Doctores
                    Recientes
                  </h5>
                  <a href="/doctors/management" class="btn btn-sm btn-primary"
                    >Ver Todos</a
                  >
                </div>
                <div class="card-body">
                  <div id="recent-doctors">
                    <!-- Se carga dinámicamente -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actividad Reciente (expandida) -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header bg-white">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-bell me-2 text-warning"></i>Actividad
                    Reciente del Sistema
                  </h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="text-muted mb-3">Registros Médicos</h6>
                      <div id="medical-activity">
                        <!-- Actividad médica reciente -->
                      </div>
                    </div>
                    <div class="col-md-6">
                      <h6 class="text-muted mb-3">Actividad Física</h6>
                      <div id="physical-activity">
                        <!-- Actividad física reciente -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Alertas del Sistema -->
          <div class="row">
            <div class="col-12">
              <div class="card shadow-sm border-warning">
                <div class="card-header bg-warning text-dark">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Alertas del
                    Sistema
                  </h5>
                </div>
                <div class="card-body">
                  <div id="system-alerts">
                    <!-- Alertas se cargan dinámicamente -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      class AdminDashboardManager {
        constructor() {
          this.baseURL = window.location.origin;
          this.init();
        }

        async init() {
          await this.checkAuth();
          await this.loadAdminInfo();
          this.setupEventListeners();
          this.setCurrentDate();
          await this.loadDashboardData();
        }

        async checkAuth() {
          const token = localStorage.getItem('access_token');
          if (!token) {
            window.location.href = '/auth/login';
            return false;
          }
          return true;
        }

        async makeAuthenticatedRequest(url, options = {}) {
          const token = localStorage.getItem('access_token');
          const defaultOptions = {
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          };
          const mergedOptions = { ...defaultOptions, ...options };

          try {
            const response = await fetch(url, mergedOptions);
            if (response.status === 401) {
              this.logout();
              return null;
            }
            return response;
          } catch (error) {
            console.error('Request failed:', error);
            return null;
          }
        }

        async loadAdminInfo() {
          const response =
            await this.makeAuthenticatedRequest('/admins/api/me');
          if (response && response.ok) {
            const admin = await response.json();
            document.getElementById('user-name').textContent = admin.nombre;
          }
        }

        async loadDashboardData() {
          await this.loadStats();
          await this.loadRecentUsers();
          await this.loadRecentDoctors();
          await this.loadRecentActivity();
          await this.loadSystemAlerts();
        }

        async loadStats() {
          // Cargar estadísticas generales
          const doctorsResponse =
            await this.makeAuthenticatedRequest('/doctors');
          const usersResponse = await this.makeAuthenticatedRequest('/users');

          if (
            doctorsResponse &&
            doctorsResponse.ok &&
            usersResponse &&
            usersResponse.ok
          ) {
            const doctors = await doctorsResponse.json();
            const users = await usersResponse.json();

            document.getElementById('total-doctors').textContent =
              doctors.length;
            document.getElementById('total-users').textContent = users.length;

            // Calcular métricas adicionales
            this.calculateAdditionalMetrics(users);
          }
        }

        calculateAdditionalMetrics(users) {
          // Calcular promedio de IMC
          const validUsers = users.filter(
            (user) => user.altura && user.peso_actual,
          );
          if (validUsers.length > 0) {
            const totalBMI = validUsers.reduce((sum, user) => {
              const heightInMeters = user.altura / 100;
              return sum + user.peso_actual / (heightInMeters * heightInMeters);
            }, 0);
            const avgBMI = totalBMI / validUsers.length;
            document.getElementById('avg-bmi').textContent = avgBMI.toFixed(1);
          }

          // Simular registros de hoy
          document.getElementById('today-records').textContent =
            Math.floor(Math.random() * 20) + 5;

          // Simular cambios semanales
          document.getElementById('doctors-change').textContent =
            `+${Math.floor(Math.random() * 5)} esta semana`;
          document.getElementById('users-change').textContent =
            `+${Math.floor(Math.random() * 15)} esta semana`;
        }

        async loadRecentUsers() {
          const response = await this.makeAuthenticatedRequest('/users');
          if (response && response.ok) {
            const users = await response.json();
            const recentUsers = users.slice(-5).reverse(); // Últimos 5 usuarios
            this.renderRecentUsers(recentUsers);
          }
        }

        renderRecentUsers(users) {
          const container = document.getElementById('recent-users');
          container.innerHTML = users
            .map(
              (user) => `
                    <div class="recent-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${user.nombre}</strong>
                                <div class="text-muted small">${user.email}</div>
                                <div class="small">
                                    <span class="badge bg-light text-dark">${user.altura || 'N/A'} cm</span>
                                    <span class="badge bg-light text-dark">${user.peso_actual || 'N/A'} kg</span>
                                </div>
                            </div>
                            <a href="/users/detail?id=${user.id}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </div>
                `,
            )
            .join('');
        }

        async loadRecentDoctors() {
          const response = await this.makeAuthenticatedRequest('/doctors');
          if (response && response.ok) {
            const doctors = await response.json();
            const recentDoctors = doctors.slice(-5).reverse(); // Últimos 5 doctores
            this.renderRecentDoctors(recentDoctors);
          }
        }

        renderRecentDoctors(doctors) {
          const container = document.getElementById('recent-doctors');
          container.innerHTML = doctors
            .map(
              (doctor) => `
                    <div class="recent-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${doctor.nombre}</strong>
                                <div class="text-muted small">${doctor.email}</div>
                                <div class="small">
                                    <span class="badge bg-primary">${doctor.especialidad || 'General'}</span>
                                </div>
                            </div>
                            <a href="/doctors/management" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </div>
                `,
            )
            .join('');
        }

        async loadRecentActivity() {
          // Simular actividad reciente
          const medicalActivity = [
            {
              type: 'Historial Médico',
              user: 'Ana López',
              action: 'actualizado',
              time: 'Hace 2 horas',
            },
            {
              type: 'Alergias',
              user: 'Carlos Ruiz',
              action: 'agregadas',
              time: 'Hace 4 horas',
            },
            {
              type: 'Medicamentos',
              user: 'María García',
              action: 'registrados',
              time: 'Hace 6 horas',
            },
          ];

          const physicalActivity = [
            {
              type: 'Caminata',
              user: 'Juan Pérez',
              duration: '30 min',
              time: 'Hace 1 hora',
            },
            {
              type: 'Natación',
              user: 'Laura Martínez',
              duration: '45 min',
              time: 'Hace 3 horas',
            },
            {
              type: 'Yoga',
              user: 'Pedro Sánchez',
              duration: '60 min',
              time: 'Hace 5 horas',
            },
          ];

          this.renderRecentActivity(medicalActivity, physicalActivity);
        }

        renderRecentActivity(medical, physical) {
          const medicalContainer = document.getElementById('medical-activity');
          const physicalContainer =
            document.getElementById('physical-activity');

          medicalContainer.innerHTML = medical
            .map(
              (item) => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <small class="fw-bold">${item.user}</small><br>
                            <small class="text-muted">${item.type} ${item.action}</small>
                        </div>
                        <small class="text-muted">${item.time}</small>
                    </div>
                `,
            )
            .join('');

          physicalContainer.innerHTML = physical
            .map(
              (item) => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <small class="fw-bold">${item.user}</small><br>
                            <small class="text-muted">${item.type} - ${item.duration}</small>
                        </div>
                        <small class="text-muted">${item.time}</small>
                    </div>
                `,
            )
            .join('');
        }

        async loadSystemAlerts() {
          // Simular alertas del sistema
          const alerts = [
            {
              type: 'warning',
              message: '3 usuarios sin doctor asignado',
              action: 'Revisar',
            },
            {
              type: 'info',
              message: 'Backup programado para hoy a las 2:00 AM',
              action: 'Ok',
            },
            {
              type: 'success',
              message: 'Sistema actualizado a la versión 2.1.0',
              action: 'Ver detalles',
            },
          ];

          this.renderSystemAlerts(alerts);
        }

        renderSystemAlerts(alerts) {
          const container = document.getElementById('system-alerts');
          container.innerHTML = alerts
            .map(
              (alert) => `
                    <div class="alert alert-${alert.type} d-flex justify-content-between align-items-center">
                        <span>${alert.message}</span>
                        <button class="btn btn-sm btn-outline-${alert.type}">${alert.action}</button>
                    </div>
                `,
            )
            .join('');
        }

        setupEventListeners() {
          document
            .getElementById('logout-btn')
            .addEventListener('click', (e) => {
              e.preventDefault();
              this.logout();
            });
        }

        setCurrentDate() {
          const now = new Date();
          const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          };
          document.getElementById('current-date').textContent =
            now.toLocaleDateString('es-ES', options);
        }

        logout() {
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
          window.location.href = '/auth/login';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        new AdminDashboardManager();
      });
    </script>
  </body>
</html>
